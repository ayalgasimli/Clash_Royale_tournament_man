<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tournament Hub</title>
    <style>
        :root {
            --bg: #0b1020;
            --card: #161f3a;
            --text: #e9eeff;
            --muted: #94a3b8;
            --line: rgba(255, 255, 255, .08);
            --accent: #7c5cff;
            --accent2: #2ee59d;
            --winner: #2ee59d;
            --loser: #ff4d6d;
            --shadow: 0 12px 30px rgba(0, 0, 0, .35);
            --radius: 16px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            background-image:
                radial-gradient(at 0% 0%, rgba(124, 92, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(46, 229, 157, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .wrap {
            width: 100%;
            max-width: 1500px;
            margin: 28px auto;
            padding: 0 16px 60px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- NAVIGATION --- */
        .nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .nav-btn.active,
        .nav-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* --- LAYOUT UTILS --- */
        .hidden {
            display: none !important;
        }

        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 8px 16px;
            border-radius: 99px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* --- LISTS & CARDS --- */
        .tourney-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .tourney-card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .tourney-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .t-name {
            font-size: 18px;
            font-weight: bold;
            display: block;
            margin-bottom: 6px;
        }

        .t-date {
            font-size: 12px;
            color: var(--muted);
            display: block;
        }

        /* --- TABLES --- */
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            min-height: 220px;
            box-shadow: rgba(0, 0, 0, 0.18) 0px 20px 40px -20px;
        }

        .card-matches {
            min-height: 300px;
        }

        .matches-scroll {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 6px;
        }

        .matches-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .matches-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 999px;
        }

        details.round-block {
            border: 1px solid var(--line);
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        details.round-block summary {
            list-style: none;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.03);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--muted);
        }

        details.round-block summary::-webkit-details-marker {
            display: none;
        }

        h2 {
            margin: 0 0 15px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border-bottom: 1px solid var(--line);
            padding: 12px 8px;
            text-align: left;
            font-size: 14px
        }

        th {
            color: var(--muted);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }

        .rank-1 {
            color: #ffd700;
            font-weight: bold;
        }

        .rank-2 {
            color: #c0c0c0;
            font-weight: bold;
        }

        .rank-3 {
            color: #cd7f32;
            font-weight: bold;
        }

        .avatar-sm {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            background: #333;
            margin-right: 8px;
            vertical-align: middle;
        }

        .p-link {
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .p-link:hover {
            color: var(--accent2);
        }

        /* --- MATCHES --- */
        .match-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--line);
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 8px;
            min-height: 80px;
        }

        .match-row.clickable {
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .match-row.clickable:hover {
            border-color: var(--accent);
            background: rgba(124, 92, 255, 0.15);
        }

        .m-round {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: bold;
            margin-top: 12px;
        }

        .vs-side {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 40%;
            font-size: 14px;
        }

        .vs-side.right {
            justify-content: flex-end;
            text-align: right;
            flex-direction: row-reverse;
        }

        .vs-mid {
            color: var(--muted);
            font-size: 12px;
            font-weight: bold;
            width: 20%;
            text-align: center;
        }

        .win {
            color: var(--winner);
            font-weight: bold;
        }

        .lose {
            opacity: 0.5;
        }

        .lose img {
            filter: grayscale(1);
        }

        /* --- RIVALRY --- */
        .rivalry-select {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--line);
            color: white;
            border-radius: 8px;
        }

        .big-vs {
            font-size: 20px;
            font-weight: bold;
            color: var(--muted);
        }

        .rivalry-score {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .r-big {
            font-size: 32px;
            font-weight: bold;
            display: block;
            margin: 10px 0;
        }

        .r-names {
            font-size: 14px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .profile-card {
            background: #1c2540;
            border: 1px solid var(--accent);
            width: 340px;
            border-radius: 20px;
            overflow: hidden;
            transform: scale(0.9);
            transition: 0.3s;
            box-shadow: 0 0 40px rgba(124, 92, 255, 0.2);
        }

        .modal-overlay.open .profile-card {
            transform: scale(1);
        }

        .pc-header {
            background: linear-gradient(45deg, var(--accent), #5035b4);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .pc-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            background: #333;
            margin: 0 auto 10px;
            object-fit: cover;
            display: block;
        }

        .pc-name {
            font-size: 22px;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        .pc-tag {
            background: rgba(0, 0, 0, 0.3);
            color: rgba(255, 255, 255, 0.8);
            padding: 4px 10px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }

        .pc-stats {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--line);
        }

        .stat-val {
            font-size: 18px;
            font-weight: bold;
            color: var(--text);
            display: block;
        }

        .stat-lbl {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            margin-top: 4px;
            display: block;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            cursor: pointer;
        }

        .loader {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        /* Match detail modal */
        .match-detail-card {
            background: #1b2342;
            border: 1px solid var(--accent);
            border-radius: 24px;
            width: min(900px, 95vw);
            max-height: 90vh;
            overflow: auto;
            padding: 24px;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
        }

        .match-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-badge {
            font-size: 28px;
            font-weight: 700;
        }

        .match-detail-body {
            display: grid;
            gap: 24px;
        }

        .deck-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .deck-grid {
                grid-template-columns: repeat(2, minmax(360px, 1fr));
            }
        }

        .deck-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
        }

        .deck-card.compact {
            max-width: 380px;
            margin: 0 auto;
        }

        .deck-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .deck-tab {
            flex: 1;
            border: 1px solid var(--line);
            background: rgba(0, 0, 0, 0.2);
            color: var(--muted);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .deck-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .deck-card h4 {
            margin: 0 0 8px;
        }

        .deck-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .deck-cards img {
            width: 100%;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .deck-actions {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .deck-actions a {
            color: var(--accent2);
            font-weight: 600;
            text-decoration: none;
        }

        .match-block {
            margin-bottom: 16px;
        }

        .match-dropdown {
            display: none;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 24px;
            margin-top: 14px;
            width: 100%;
        }

        .match-dropdown.open {
            display: block;
        }

        .battle-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .battle-item {
            border: 1px solid var(--line);
            border-radius: 16px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        .battle-item summary {
            list-style: none;
            cursor: pointer;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            background: rgba(255, 255, 255, 0.02);
        }

        .battle-item summary::-webkit-details-marker {
            display: none;
        }

        .battle-item summary .summary-meta {
            font-size: 11px;
            text-transform: none;
            color: var(--muted);
            font-weight: 400;
        }

        .battle-card {
            padding: 18px;
            border-top: 1px solid var(--line);
        }

        .battle-grid {
            display: grid;
            grid-template-columns: minmax(220px, 320px) 1fr;
            gap: 20px;
            align-items: start;
        }

        .battle-summary {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .battle-summary .summary-meta {
            font-size: 12px;
            color: var(--muted);
        }

        .battle-summary .score {
            font-size: 32px;
            font-weight: 700;
        }

        .battle-summary .details {
            font-size: 12px;
            color: var(--muted);
        }

        @media (max-width: 900px) {
            .battle-grid {
                grid-template-columns: 1fr;
            }
        }

        .battle-card.diff-low {
            border-left: 4px solid var(--accent2);
        }

        .battle-card.diff-mid {
            border-left: 4px solid #ffd266;
        }

        .battle-card.diff-high {
            border-left: 4px solid var(--loser);
        }

        .battle-card.three-crown {
            background: rgba(255, 215, 0, 0.12);
            box-shadow: inset 0 0 25px rgba(255, 215, 0, 0.2);
        }

        @media (max-width: 768px) {
            .match-row {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .match-row .vs-side,
            .match-row .vs-side.right {
                justify-content: center;
                flex-direction: row;
            }

            .match-row .vs-mid {
                width: auto;
            }
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="profileModal">
        <div class="profile-card">
            <div class="pc-header">
                <button class="close-modal" onclick="closeProfile()">‚úï</button>
                <img src="" class="pc-avatar" id="pmImg">
                <h3 class="pc-name" id="pmName">Name</h3>
                <span class="pc-tag" id="pmTag">#TAG</span>
            </div>
            <div class="pc-stats">
                <div class="stat-box">
                    <span class="stat-val" id="pmTrophies">0</span>
                    <span class="stat-lbl">üèÜ Trophies</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val" id="pmRank">Unranked</span>
                    <span class="stat-lbl">Best Rank</span>
                </div>
                <div class="stat-box" style="grid-column:span 2">
                    <span class="stat-val" id="pmCard" style="font-size:14px; color:var(--accent)">-</span>
                    <span class="stat-lbl">Favorite Card</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="matchModal">
        <div class="match-detail-card">
            <button class="close-modal" onclick="closeMatchModal()">‚úï</button>
            <div class="match-detail-header">
                <div>
                    <div id="matchModalTitle" style="font-size:18px; font-weight:600;">Match Details</div>
                    <div id="matchModalMeta" style="font-size:12px; color:var(--muted);">Mode ‚Ä¢ Date</div>
                </div>
                <div class="score-badge" id="matchModalScore">0 - 0</div>
            </div>
            <div class="match-detail-body" id="matchModalBody">
                <div class="loader">Fetching decks...</div>
            </div>
        </div>
    </div>

    <div class="wrap">

        <div class="nav">
            <button class="nav-btn active" id="navTourney" onclick="switchMainTab('tourney')">Tournaments</button>
            <button class="nav-btn" id="navStats" onclick="switchMainTab('stats')">Global Stats</button>
            <button class="nav-btn" id="navRival" onclick="switchMainTab('rival')">Head-to-Head</button>
        </div>

        <div id="tourneySection">
            <div id="listView">
                <div id="listLoader" class="loader">Loading tournaments...</div>
                <div id="tourneyGrid" class="tourney-grid"></div>
            </div>

            <div id="detailView" class="hidden">
                <header>
                    <button class="btn-back" id="backBtn">‚Üê Back to List</button>
                    <div style="text-align:right"><button class="btn-back" id="refreshBtn">‚Üª Refresh</button></div>
                </header>
                <div style="text-align:center; margin-bottom:30px;">
                    <h1 id="dName">Tournament</h1>
                    <span id="dDate" style="color:var(--muted)"></span>
                </div>
                <div class="detail-grid">
                    <div class="card card-standings">
                        <h2>Standings</h2>
                        <div id="standingsArea"></div>
                    </div>
                    <div class="card card-matches">
                        <h2>Matches</h2>
                        <div class="matches-scroll">
                            <div id="matchesArea"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="statsSection" class="hidden">
            <div class="card">
                <h2>All-Time Leaderboard</h2>
                <div id="globalStatsArea">
                    <div class="loader">Calculating...</div>
                </div>
            </div>
        </div>

        <div id="rivalSection" class="hidden">
            <div class="card">
                <h2>Rivalry Checker</h2>
                <div class="rivalry-select">
                    <select id="p1Select">
                        <option>Player 1</option>
                    </select>
                    <div class="big-vs">VS</div>
                    <select id="p2Select">
                        <option>Player 2</option>
                    </select>
                </div>
                <div id="rivalryResult" class="hidden">
                    <div class="rivalry-score">
                        <div class="r-names"><span id="rName1">P1</span> <span id="rName2">P2</span></div>
                        <div class="r-big"><span id="rScore1" style="color:var(--accent2)">0</span> - <span id="rScore2"
                                style="color:var(--loser)">0</span></div>
                        <div style="font-size:12px; color:var(--muted)">All-time record</div>
                    </div>
                    <div id="rivalryHistory"></div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        const SUPABASE_URL = "https://izmzpnfpcdxdqwgghsyq.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_4kW-ZwFSbzqPkWz63jYcGw_Kldfdp7R";
        const API_PROXY_URL = localStorage.getItem('cr_public_api') || "http://localhost:8000";

        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const $ = (id) => document.getElementById(id);
        let currentTid = null;
        let playersMap = new Map(); // Store full player objects
        const matchMap = new Map();
        const battleLogCache = new Map();
        const battleDeckCache = new Map();
        const desktopQuery = window.matchMedia('(min-width: 1024px)');

        // --- MAIN TABS ---
        window.switchMainTab = (tab) => {
            ['tourney', 'stats', 'rival'].forEach(t => {
                $(`nav${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.remove('active');
                $(`${t}Section`).classList.add('hidden');
            });

            if (tab === 'tourney') {
                $('navTourney').classList.add('active');
                $('tourneySection').classList.remove('hidden');
            } else if (tab === 'stats') {
                $('navStats').classList.add('active');
                $('statsSection').classList.remove('hidden');
                loadGlobalStats();
            } else if (tab === 'rival') {
                $('navRival').classList.add('active');
                $('rivalSection').classList.remove('hidden');
                loadRivalryInputs();
            }
        }

        // --- VIEW 1: TOURNAMENTS ---
        async function loadList() {
            const { data } = await supabase.from("tournaments").select("id,name,created_at").order("created_at", { ascending: false }).limit(50);
            $('listLoader').classList.add('hidden');
            $('tourneyGrid').innerHTML = data.map(t => `
            <div class="tourney-card" data-id="${t.id}">
                <span class="t-name">${escapeHtml(t.name)}</span>
                <span class="t-date">${fmtDate(t.created_at)}</span>
            </div>
        `).join("");
            document.querySelectorAll('.tourney-card').forEach(card => card.addEventListener('click', () => openTournament(card.getAttribute('data-id'))));
        }

        async function openTournament(tid) {
            currentTid = tid;
            $('listView').classList.add('hidden');
            $('detailView').classList.remove('hidden');
            $('dName').textContent = "Loading...";
            $('standingsArea').innerHTML = '<div class="loader">Loading...</div>';

            const { data: info } = await supabase.from("tournaments").select("*").eq("id", tid).single();
            if (info) { $('dName').textContent = info.name; $('dDate').textContent = fmtDate(info.created_at); }
            loadDetails(tid);
        }

        async function loadDetails(tid) {
            const { data: matches } = await supabase.from("matches").select("*, playersA:player_a_id(*), playersB:player_b_id(*)").eq("tournament_id", tid).order("round_number", { ascending: true });
            const { data: players } = await supabase.from("tournament_players").select("player_id, players(*)").eq("tournament_id", tid);

            playersMap.clear();
            matchMap.clear();
            const stats = new Map();
            if (players) players.forEach(p => { playersMap.set(p.player_id, p.players); stats.set(p.player_id, { ...p.players, w: 0, l: 0, pts: 0 }); });
            if (matches) matches.forEach(m => matchMap.set(m.id, m));

            const rounds = {};
            if (matches) {
                matches.forEach(m => {
                    if (!rounds[m.round_number]) rounds[m.round_number] = [];
                    rounds[m.round_number].push(m);
                    if (m.completed && m.winner_id) {
                        const pA = stats.get(m.player_a_id); const pB = stats.get(m.player_b_id);
                        if (pA && pB) {
                            if (m.winner_id === m.player_a_id) { pA.w++; pA.pts += 3; pB.l++; } else { pB.w++; pB.pts += 3; pA.l++; }
                        }
                    }
                });
            }
            renderStandings(stats);
            renderMatches(rounds);
        }

        // --- VIEW 2: GLOBAL STATS ---
        async function loadGlobalStats() {
            const { data: players, error: playersErr } = await supabase.from("players").select("*");
            const { data: matches, error: matchesErr } = await supabase.from("matches").select("*").eq("completed", true);

            // Handle errors or empty data
            if (playersErr || !players || players.length === 0) {
                $('globalStatsArea').innerHTML = '<div class="loader">No players found.</div>';
                return;
            }
            if (matchesErr || !matches) {
                $('globalStatsArea').innerHTML = '<div class="loader">Could not load matches.</div>';
                return;
            }

            const stats = {};
            players.forEach(p => stats[p.id] = { ...p, w: 0, l: 0, total: 0 });

            matches.forEach(m => {
                // Skip matches without valid winner
                if (!m.winner_id) return;

                const w = stats[m.winner_id];
                const loserId = m.winner_id === m.player_a_id ? m.player_b_id : m.player_a_id;
                const l = stats[loserId];
                if (w) { w.w++; w.total++; }
                if (l) { l.l++; l.total++; }
            });

            const list = Object.values(stats)
                .filter(p => p.total > 0) // Only show players who played
                .sort((a, b) => (b.w - a.w) || (b.w / b.total - a.w / a.total));

            if (list.length === 0) {
                $('globalStatsArea').innerHTML = '<div class="loader">No completed matches yet.</div>';
                return;
            }

            let html = `<table><thead><tr><th>#</th><th>Player</th><th>Matches</th><th>Wins</th><th>Win Rate</th></tr></thead><tbody>`;
            list.forEach((p, i) => {
                const wr = Math.round((p.w / p.total) * 100);
                html += `<tr>
                <td>${i + 1}</td>
                <td><img src="${p.avatar_url || ''}" class="avatar-sm"><span class="p-link" onclick="openProfile('${p.id}')">${p.name}</span></td>
                <td>${p.total}</td>
                <td style="color:var(--accent2); font-weight:bold">${p.w}</td>
                <td>${wr}%</td>
            </tr>`;
            });
            html += `</tbody></table>`;
            $('globalStatsArea').innerHTML = html;

            // Cache players for modal
            players.forEach(p => playersMap.set(p.id, p));
        }

        // --- VIEW 3: RIVALRY ---
        async function loadRivalryInputs() {
            const { data: players } = await supabase.from("players").select("*").order('name');
            const opts = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            $('p1Select').innerHTML = `<option value="">Select P1</option>` + opts;
            $('p2Select').innerHTML = `<option value="">Select P2</option>` + opts;

            // Listener
            const check = async () => {
                const p1 = $('p1Select').value;
                const p2 = $('p2Select').value;
                if (p1 && p2 && p1 !== p2) runRivalry(p1, p2, players);
            }
            $('p1Select').onchange = check;
            $('p2Select').onchange = check;
        }

        async function runRivalry(p1Id, p2Id, allPlayers) {
            const p1 = allPlayers.find(p => p.id === p1Id);
            const p2 = allPlayers.find(p => p.id === p2Id);

            const { data: matches } = await supabase.from("matches").select("*")
                .or(`player_a_id.eq.${p1Id},player_b_id.eq.${p1Id}`)
                .eq("completed", true);

            // Filter purely JS side for simplicity
            const h2h = matches.filter(m => (m.player_a_id === p2Id || m.player_b_id === p2Id));

            $('rivalryResult').classList.remove('hidden');
            $('rName1').innerText = p1.name; $('rName2').innerText = p2.name;

            let s1 = 0, s2 = 0;
            let histHtml = '';

            h2h.forEach(m => {
                const p1Won = m.winner_id === p1Id;
                if (p1Won) s1++; else s2++;

                const resClass = p1Won ? "win" : "lose";
                const resText = p1Won ? "Won" : "Lost";
                histHtml += `<div class="match-row" style="font-size:12px">
                <span style="color:var(--muted)">Round ${m.round_number}</span>
                <span class="${resClass}">${resText}</span>
            </div>`;
            });

            $('rScore1').innerText = s1; $('rScore2').innerText = s2;
            $('rivalryHistory').innerHTML = histHtml || '<div style="text-align:center; padding:10px; color:var(--muted)">No matches found between them.</div>';
        }

        // --- RENDERERS & HELPERS ---
        function renderStandings(map) {
            // --- FIX: Removed Trophy Sorting for Fairness ---
            const list = [...map.values()].sort((a, b) => b.pts - a.pts);

            let html = `<table><thead><tr><th>#</th><th>Player</th><th>W</th><th>L</th><th>Pts</th></tr></thead><tbody>`;
            list.forEach((p, i) => {
                const r = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
                html += `<tr><td class="${r}">${i + 1}</td><td><img src="${p.avatar_url || ''}" class="avatar-sm"><span class="p-link" onclick="openProfile('${p.id}')">${escapeHtml(p.name)}</span></td><td>${p.w}</td><td>${p.l}</td><td style="font-weight:bold">${p.pts}</td></tr>`;
            });
            $('standingsArea').innerHTML = list.length ? html + `</tbody></table>` : '<div class="loader">No players.</div>';
        }

        function renderMatches(rounds) {
            battleDeckCache.clear();
            let html = "";
            Object.keys(rounds).sort((a, b) => a - b).forEach((r, idx) => {
                html += `<details class="round-block" ${idx === 0 ? 'open' : ''}>
                    <summary>Round ${r}<span style="font-size:11px; color:var(--muted);">Matches: ${rounds[r].length}</span></summary>
                    <div style="padding:14px 16px;">`;
                rounds[r].forEach(m => {
                    const pA = m.playersA, pB = m.playersB;
                    let cA = "vs-side", cB = "vs-side right", mid = "vs";
                    if (m.completed) {
                        if (m.winner_id == m.player_a_id) { cA += " win"; cB += " lose"; mid = `1 - 0`; } else { cB += " win"; cA += " lose"; mid = `0 - 1`; }
                    }
                    html += `
                    <div class="match-block">
                        <div class="match-row clickable" onclick="toggleMatchDropdown('${m.id}')">
                            <div class="${cA}"><img src="${pA?.avatar_url || ''}" class="avatar-sm"><span>${escapeHtml(pA?.name)}</span></div>
                            <div class="vs-mid">${mid}</div>
                            <div class="${cB}"><img src="${pB?.avatar_url || ''}" class="avatar-sm"><span>${escapeHtml(pB?.name)}</span></div>
                        </div>
                        <div class="match-dropdown" id="matchDropdown-${m.id}">
                            <div style="font-size:12px; color:var(--muted);">Click above to load match details.</div>
                        </div>
                    </div>`;
                });
                html += `</div></details>`;
            });
            $('matchesArea').innerHTML = html || '<div class="loader">No matches.</div>';
            handleResponsiveDropdowns();
        }

        window.openProfile = (pid) => {
            const p = playersMap.get(pid); if (!p) return;
            $('pmName').innerText = p.name; $('pmTag').innerText = p.tag || "#UNKNOWN";
            $('pmTrophies').innerText = p.trophies; $('pmRank').innerText = p.best_rank > 0 ? `#${p.best_rank}` : "Unranked";
            $('pmCard').innerText = p.favorite_card || "-"; $('pmImg').src = p.avatar_url;
            $('profileModal').classList.add('open');
        }
        window.closeProfile = () => $('profileModal').classList.remove('open');
        function escapeHtml(s) { return (s ?? "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function fmtDate(d) { try { return new Date(d).toLocaleDateString(); } catch { return d; } }

        // MATCH DETAIL MODAL
        window.openMatchDetails = async (mid) => {
        const match = matchMap.get(mid);
        if (!match) return;
        const title = `${match.playersA?.name || 'Player A'} vs ${match.playersB?.name || 'Player B'}`;
        $('matchModalTitle').innerText = title;
        $('matchModalMeta').innerText = 'Loading...';
        $('matchModalScore').innerText = '-';
        $('matchModalBody').innerHTML = '<div class="loader">Fetching decks from Clash Royale...</div>';
        $('matchModal').classList.add('open');
        try {
            const battles = await findBattlesForMatch(match);
            if (!battles.length) {
                $('matchModalBody').innerHTML = `<div class="loader">No recent battles found between these players. Results may still be pending.</div>`;
                $('matchModalMeta').innerText = 'No battle data yet';
                $('matchModalScore').innerText = match.completed ? (match.winner_id === match.player_a_id ? '1 - 0' : '0 - 1') : '-';
                return;
            }
            const primary = battles[0];
            const participants = mapBattlePlayers(primary, match);
            $('matchModalMeta').innerText = formatBattleMeta(primary);
            $('matchModalScore').innerText = `${participants.playerA?.crowns ?? 0} - ${participants.playerB?.crowns ?? 0}`;
            $('matchModalBody').innerHTML = renderBattleList(battles, match, 'modal');
        } catch (err) {
            $('matchModalBody').innerHTML = `<div class="loader">Failed to load decks: ${escapeHtml(err.message || err)}</div>`;
            $('matchModalMeta').innerText = 'Error loading battle data';
            $('matchModalScore').innerText = '-';
        }
        }

        window.closeMatchModal = () => $('matchModal').classList.remove('open');

        window.toggleMatchDropdown = async (mid) => {
            if (!isDesktopView()) {
                openMatchDetails(mid);
                return;
            }
            const panel = document.getElementById(`matchDropdown-${mid}`);
            if (!panel) return;
            const shouldOpen = !panel.classList.contains('open');
            if (shouldOpen) {
                panel.classList.add('open');
                await loadMatchDropdown(mid);
            } else {
                panel.classList.remove('open');
            }
        }

        async function loadMatchDropdown(mid) {
            if (!isDesktopView()) return;
            const panel = document.getElementById(`matchDropdown-${mid}`);
            if (!panel || panel.dataset.loading === 'true') return;
            const match = matchMap.get(mid);
            if (!match) {
                panel.innerHTML = '<div class="loader">Match data missing.</div>';
                return;
            }
            panel.innerHTML = '<div class="loader">Loading battle data...</div>';
            panel.dataset.loading = 'true';
            try {
                const battles = await findBattlesForMatch(match);
                if (!battles.length) {
                    panel.innerHTML = '<div class="loader">No recent battles found.</div>';
                } else {
                    panel.innerHTML = renderBattleList(battles, match, 'inline');
                    panel.dataset.loaded = 'true';
                }
            } catch (err) {
                panel.innerHTML = `<div class="loader">Failed: ${escapeHtml(err.message || err)}</div>`;
            } finally {
                delete panel.dataset.loading;
            }
        }

        async function findBattlesForMatch(match) {
            const combos = [
                { primary: match.playersA, opponent: match.playersB },
                { primary: match.playersB, opponent: match.playersA }
            ];
            const found = [];
            const seen = new Set();
            for (const combo of combos) {
                const tag = combo.primary?.tag;
                const oppTag = combo.opponent?.tag;
                if (!tag || !oppTag) continue;
                const log = await fetchBattleLog(tag);
                const normalizedOpp = normalizeTag(oppTag);
                log.forEach(b => {
                    const opponent = (b.opponent || [])[0];
                    if (!opponent || normalizeTag(opponent.tag) !== normalizedOpp) return;
                    const key = `${b.battleTime}-${opponent.tag}-${b.type}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    found.push(b);
                });
            }
            return found.sort((a, b) => parseBattleTime(b.battleTime) - parseBattleTime(a.battleTime));
        }

        async function fetchBattleLog(playerTag) {
            const normalized = normalizeTag(playerTag);
            const cached = battleLogCache.get(normalized);
            const now = Date.now();
            if (cached && now - cached.timestamp < 5_000) {
                return cached.data;
            }
            const response = await fetch(API_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerTag, mode: 'battlelog' })
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `Proxy error (${response.status})`);
            }
            const data = await response.json();
            battleLogCache.set(normalized, { data, timestamp: now });
            return data;
        }

        function mapBattlePlayers(battle, match) {
            const tagA = normalizeTag(match.playersA?.tag);
            const tagB = normalizeTag(match.playersB?.tag);
            const lookup = (list) => {
                const map = {};
                (list || []).forEach(p => map[normalizeTag(p.tag || '')] = p);
                return map;
            };
            const team = lookup(battle.team);
            const opponent = lookup(battle.opponent);
            const playerA = team[tagA] || opponent[tagA];
            const playerB = team[tagB] || opponent[tagB];
            return { playerA, playerB };
        }

        function renderSingleDeck(playerData, label) {
            if (!playerData) {
                return `<div class="deck-card compact"><h4>${escapeHtml(label)}</h4><div style="color:var(--muted); font-size:13px;">No cards recorded.</div></div>`;
            }
            const cards = playerData.cards || [];
            const deckLink = cards.length ? `https://link.clashroyale.com/deck/en?deck=${cards.map(c => c.id).join(';')}` : null;
            return `
                <div class="deck-card compact">
                    <h4>${escapeHtml(label)}</h4>
                    <div class="deck-cards">
                        ${cards.map(c => `<img src="${c.iconUrls?.medium || ''}" alt="${escapeHtml(c.name)}">`).join('')}
                    </div>
                    <div class="deck-actions">
                        <span>${cards.length ? 'Tap a card to inspect in Clash Royale.' : 'No deck data.'}</span>
                        ${deckLink ? `<a href="${deckLink}" target="_blank" rel="noopener">Copy Deck</a>` : ''}
                    </div>
                </div>
            `;
        }

        function normalizeTag(tag) {
            return (tag || '').replace(/#/g, '').trim().toUpperCase();
        }

        function parseBattleTime(value) {
            const yr = value.slice(0, 4), mo = value.slice(4, 6), day = value.slice(6, 8);
            const hr = value.slice(9, 11), min = value.slice(11, 13), sec = value.slice(13, 15);
            return Date.UTC(+yr, +mo - 1, +day, +hr, +min, +sec);
        }

        function formatBattleMeta(battle) {
            const mode = battle.gameMode?.name || 'Unknown Mode';
            const ts = new Date(parseBattleTime(battle.battleTime)).toLocaleString();
            return `${mode} ‚Ä¢ ${ts}`;
        }

        function renderBattleList(battles, match, context = 'inline') {
            return `<div class="battle-list">
                ${battles.map((battle, idx) => renderBattleItem(battle, idx + 1, match, context, idx === 0)).join('')}
            </div>`;
        }

        function renderBattleItem(battle, index, match, context, openByDefault) {
            const participants = mapBattlePlayers(battle, match);
            const scoreA = participants.playerA?.crowns ?? 0;
            const scoreB = participants.playerB?.crowns ?? 0;
            const diff = Math.abs(scoreA - scoreB);
            let diffClass = diff >= 2 ? 'diff-high' : diff === 1 ? 'diff-mid' : 'diff-low';
            if (scoreA === 3 || scoreB === 3) diffClass += ' three-crown';
            const winner = scoreA === scoreB ? 'Draw' : (scoreA > scoreB ? (match.playersA?.name || 'Player A') : (match.playersB?.name || 'Player B'));
            const diffText = diff === 0 ? 'Even crowns' : `${diff} crown${diff === 1 ? '' : 's'} difference`;
            const battleKey = createBattleKey(match.id, index, battle, context);
            battleDeckCache.set(battleKey, {
                playerA: participants.playerA,
                playerB: participants.playerB,
                labelA: match.playersA?.name || 'Player A',
                labelB: match.playersB?.name || 'Player B'
            });
            return `
                <details class="battle-item ${diffClass}" ${openByDefault ? 'open' : ''}>
                    <summary>
                        <span>Battle ${index}</span>
                        <span class="summary-meta">${formatBattleMeta(battle)}</span>
                        <span>${scoreA} - ${scoreB}</span>
                    </summary>
                    <div class="battle-card">
                        <div class="battle-grid">
                            <div class="battle-summary">
                                <div class="summary-meta">${formatBattleMeta(battle)}</div>
                                <div class="score">${scoreA} - ${scoreB}</div>
                                <div class="details">
                                    Winner: ${escapeHtml(winner)}<br>${diffText}${(scoreA === 3 || scoreB === 3) ? ' ‚Ä¢ Three-Crown!' : ''}
                                </div>
                            </div>
                            <div class="battle-detail">
                                <div class="deck-toggle">
                                    <button type="button" class="deck-tab active" data-battle="${battleKey}" data-player="A">${escapeHtml(match.playersA?.name || 'Player A')}</button>
                                    <button type="button" class="deck-tab" data-battle="${battleKey}" data-player="B">${escapeHtml(match.playersB?.name || 'Player B')}</button>
                                </div>
                                <div class="deck-view" id="deckView-${battleKey}">
                                    ${renderSingleDeck(participants.playerA, match.playersA?.name || 'Player A')}
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
            `;
        }

        function createBattleKey(matchId, index, battle, context = '') {
            const raw = `${context}-${matchId || ''}-${index}-${battle.battleTime}`;
            return raw.replace(/[^a-zA-Z0-9_-]/g, '');
        }

        function handleResponsiveDropdowns() {
            if (isDesktopView()) return;
            document.querySelectorAll('[id^="matchDropdown-"]').forEach(panel => {
                panel.classList.remove('open');
                delete panel.dataset.loaded;
                delete panel.dataset.loading;
            });
        }

        function isDesktopView() {
            return desktopQuery.matches;
        }

        if (desktopQuery.addEventListener) desktopQuery.addEventListener('change', handleResponsiveDropdowns);
        else desktopQuery.addListener(handleResponsiveDropdowns);
        handleResponsiveDropdowns();

        document.addEventListener('click', (event) => {
            const tab = event.target.closest('.deck-tab');
            if (!tab) return;
            event.stopPropagation();
            const battleKey = tab.dataset.battle;
            const playerKey = tab.dataset.player;
            const info = battleDeckCache.get(battleKey);
            if (!info) return;
            const container = document.getElementById(`deckView-${battleKey}`);
            if (!container) return;
            const data = playerKey === 'A' ? info.playerA : info.playerB;
            const label = playerKey === 'A' ? info.labelA : info.labelB;
            container.innerHTML = renderSingleDeck(data, label);
            tab.parentElement.querySelectorAll('.deck-tab').forEach(btn => btn.classList.remove('active'));
            tab.classList.add('active');
        });

        document.addEventListener('toggle', (event) => {
            if (event.target.matches('.battle-item') && event.target.open) {
                const parent = event.target.parentElement;
                parent.querySelectorAll('.battle-item').forEach(item => {
                    if (item !== event.target) item.open = false;
                });
            }
        });

        $('backBtn').onclick = () => { $('listView').classList.remove('hidden'); $('detailView').classList.add('hidden'); };
        $('refreshBtn').onclick = () => { if (currentTid) loadDetails(currentTid); };

        loadList();
    </script>
</body>

</html>
